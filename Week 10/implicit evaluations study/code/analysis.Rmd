---
title: "Evaluations of positive and negative stimuli using the Affective Misattribution Procedure (AMP) and self-reports"
subtitle: "Analysis"
author: "Template: Ian Hussey; content: [Student name]"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}

# set knit options
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

# disable scientific notation
options(scipen = 999) 

```

# Dependencies

```{r}

library(tidyverse)
library(knitr)
library(kableExtra)
library(janitor)
library(scales)
library(gridExtra)
library(ggplot2)
library(ggExtra)

install.packages("devtools")
devtools::install_github("daattali/ggExtra")

```

# Data

Load the processed data and apply the global exclusions.

```{r}

data_processed <- read_csv("../data/processed/data_processed.csv")

data_processed_after_exclusions <- data_processed |>
  filter(exclude_participant == "include")

```

# Sample descriptives

## Sample size before exclusions

```{r}

data_processed |>
  count(name = "n") |>
  kable() |>
  add_header_above(header = c("Whole sample" = 1)) |> # note that you can add header rows to tables like this. The "1" indicates the number of columns the header should span. The sum of these numbers must equal the number of columns or you'll get an error.
  kable_classic(full_width = FALSE)

```

## Sample size after exclusions

Sample used in subsequent analyses

```{r}

data_processed_after_exclusions |>
  count(name = "n") |>
  kable() |>
  add_header_above(header = c("For analysis" = 1)) |>
  kable_classic(full_width = FALSE)

```

## Age

```{r}

data_processed_after_exclusions |>
  mutate(age = as.numeric(age)) |>
  summarise(Mean = mean(age, na.rm = TRUE),
            SD = sd(age, na.rm = TRUE)) |>
  mutate_all(.funs = janitor::round_half_up, digits = 1) |>
  kable() |>
  add_header_above(header = c("Age" = 2)) |>
  kable_classic(full_width = FALSE)

```

## Gender

```{r}

data_processed_after_exclusions |> 
  rename(Gender = gender) |>
  group_by(Gender) |> 
  summarise(n = n()) |> 
  mutate(Percent = paste0(round_half_up((n / sum(n)) * 100, 1), "%")) |>
  mutate(Gender = stringr::str_to_sentence(Gender)) |> # Change the case of the Gender variable so that it prints nicely
  kable() |>
  kable_classic(full_width = FALSE)

```

# Descriptives

Descriptive statistics and plots of the measures (excluding the demographics variables)

## Self-reported evaluations

### Descriptive stats

```{r}

# overall self-reported evaluations
dat_mean_ratings <- data_processed_after_exclusions |>
  summarise(Mean = mean(mean_evaluation, na.rm = TRUE),
            SD = sd(mean_evaluation, na.rm = TRUE),
            n = n()) |>
  mutate(group = "Full sample")

# self-reported evaluations by gender category
dat_mean_ratings_by_gender <- data_processed_after_exclusions |>
  group_by(group = gender) |>
  summarise(Mean = mean(mean_evaluation, na.rm = TRUE),
            SD = sd(mean_evaluation, na.rm = TRUE),
            n = n())

# combine both into one table
bind_rows(dat_mean_ratings,
          dat_mean_ratings_by_gender) |>
  select(Subset = group, Mean, SD, n) |> # select variables of interest, and rename one 
  mutate(Subset = stringr::str_to_sentence(Subset)) |> # Change the case of the Subset variable so that it prints nicely
  mutate_if(is.numeric, round_half_up, digits = 2) |>
  kable() |>
  add_header_above(header = c(" " = 1, "Self-reported evaluations" = 3)) |>
  kable_classic(full_width = FALSE)

```

### Descriptive plot

```{r}

ggplot(data_processed_after_exclusions, aes(x = mean_evaluation)) +
  geom_histogram(binwidth = 0.05,
                 boundary = 0,
                 fill = viridis_pal(begin = 0.45, option = "mako")(1), 
                 color = viridis_pal(begin = 0.30, option = "mako")(1)) + 
  xlab("Mean self-reported evaluation") +
  ylab("Frequency") +
  theme_linedraw() +
  scale_x_continuous(breaks = pretty_breaks(n = 10)) 
  

```

## AMP evaluations

### Descriptive stats

\TODO add table of means, SDs, Ns

```{r}
### Descriptive stats

# all self evluations 

dat_mean_ratings <- data_processed_after_exclusions |>
  summarise(Mean = mean(mean_evaluation, na.rm = TRUE),
            SD = sd(mean_evaluation, na.rm = TRUE),
            n = n()) |>
  mutate(group = "Full sample")

# by gender
dat_mean_ratings_by_gender <- data_processed_after_exclusions |>
  group_by(group = gender) |>
  summarise(Mean = mean(mean_evaluation, na.rm = TRUE),
            SD = sd(mean_evaluation, na.rm = TRUE),
            n = n())

# combine
bind_rows(dat_mean_ratings,
          dat_mean_ratings_by_gender) |>
  select(Subset = group, Mean, SD, n) |> 
  mutate(Subset = stringr::str_to_sentence(Subset)) |> 
  mutate_if(is.numeric, round_half_up, digits = 2) |>
  kable() |>
  add_header_above(header = c(" " = 1, "AMP evaluation" = 3)) |>
  kable_classic(full_width = FALSE)

```

### Descriptive plots

```{r}

ggplot(data_processed_after_exclusions, aes(x = AMP_score)) +
  geom_histogram(binwidth = 0.05,
                 boundary = 0,
                 fill = viridis_pal(begin = 0.45, option = "mako")(1), 
                 color = viridis_pal(begin = 0.30, option = "mako")(1)) + 
  xlab("AMP score") +
  ylab("Frequency") +
  theme_linedraw() +
  scale_x_continuous(breaks = pretty_breaks(n = 10))

```

# Analyses & hypothesis tests

## Self-reported evaluations are correlated with evaluations on the AMP

### Plot

```{r}

ggplot(data_processed_after_exclusions, 
       aes(x = AMP_score,
           y = mean_evaluation)) +
  geom_jitter(color = viridis_pal(begin = 0.45, option = "mako")(1),
              alpha = 0.5) +
  geom_smooth(method = "lm",
              color = viridis_pal(begin = 0.45, option = "mako")(1)) +
  xlab("AMP score") +
  ylab("Mean self-reported evaluation") +
  theme_linedraw() 


ggplot(data_processed_after_exclusions, 
       aes(x = AMP_score,
           y = mean_evaluation)) +
  geom_jitter(color = viridis_pal(begin = 0.45, option = "mako")(1),
              alpha = 0.5) +
  geom_smooth(method = "lm",
              color = viridis_pal(begin = 0.45, option = "mako")(1)) +
  xlab("AMP score") +
  ylab("Mean self-reported evaluation") +
  theme_linedraw() 


ggplot(data_processed_after_exclusions, 
       aes(y = AMP_score,
           x = mean_evaluation)) +
  geom_jitter(color = viridis_pal(begin = 0.45, option = "mako")(1),
              alpha = 0.5) +
  geom_smooth(method = "lm",
              color = viridis_pal(begin = 0.45, option = "mako")(1)) +
  ylab("AMP score") +
  xlab("Mean self-reported evaluation") +
  theme_linedraw() 

ggplot(data_processed_after_exclusions, 
       aes(x = AMP_score,
           y = mean_evaluation)) +
  geom_jitter(color = viridis_pal(begin = 0.45, option = "mako")(1),
              alpha = 0.5) +
  xlab("AMP score") +
  ylab("Mean self-reported evaluation") +
  theme_linedraw() 

```

More complex plots:

#### Axial hisograms

Scatter plots with axial histograms using ggExtra: https://cran.r-project.org/web/packages/ggExtra/vignettes/ggExtra.html

\TODO add axial histograms to a scatter plot. Split both the scatter plot and the histograms by gender.

```{r}
scatterplotv1 <- ggplot(data_processed_after_exclusions,
       aes(x = AMP_score,
           y = mean_evaluation,
           colour = gender)) +
    geom_jitter(alpha = 0.5) +
  xlab("AMP score") +
  ylab("Mean self-reported evaluation")
ggMarginal(scatterplotv1, groupColour = TRUE, groupFill = TRUE, type = "histogram")

print(scatterplotv1)

```

#### Labelled points

Label points using ggrepel: https://cran.r-project.org/web/packages/ggrepel/vignettes/ggrepel.html

\TODO Label the points in a scatter plot using their participant codes.

```{r}
library(viridis) # If you are using viridis for color scales
install.packages("ggrepel")
library(ggrepel)

z_threshold = 2 

pointslabeldgraph <- ggplot(data_processed_after_exclusions, 
       aes(x = AMP_score, y = mean_evaluation, label = subject)) + # Add label aesthetic
  geom_jitter(color = viridis_pal(begin = 0.45, option = "mako")(1),
              alpha = 0.5) +
  #geom_text_repel() + # Add this line for labels
  xlab("AMP score") +
  ylab("Mean self-reported evaluation") +
  theme_linedraw()

pointslabeldgraph + geom_text_repel(data = filter(data_processed_after_exclusions, abs(scale(AMP_score)) > z_threshold),
                    aes(label = subject))


```

#### Magnify areas

Magnify areas of your plot with ggmagnify: https://hughjonesd.github.io/ggmagnify/

\TODO Magnify an area of one of your scatter plots, eg where there are a lot of data points in a small area.

```{r}
# Load necessary libraries
library(ggplot2)
remotes::install_github("hughjonesd/ggmagnify")
library(ggmagnify)
library(viridis)

# Your original scatter plot
ggp <- ggplot(data_processed_after_exclusions, aes(x = AMP_score, y = mean_evaluation)) +
  geom_jitter(color = viridis_pal(begin = 0.45, option = "mako")(1), alpha = 0.5) +
  xlab("AMP score") +
  ylab("Mean self-reported evaluation") +
  theme_linedraw()

# Define the area to be magnified
# Adjust these values to the area you want to zoom in on
from <- c(xmin = 0.3, xmax = 0.8, ymin = 0.8, ymax = 1.3)

# Define where to place the magnified inset on the plot
# Adjust these values to place the inset where you like
to <- c(xmin = 0, xmax = 0.25, ymin = 4, ymax = 5)

# Add the magnified area to the plot
ggp + geom_magnify(from = from, to = to)


###is it possible to have a square automatically?

```

### Test
\TODO run an appropriate test. Below the output, print an interpretation of the results generated by the ‘easystats’ package [report](https://easystats.github.io/report/). I.e., use `report::report()`.





## Self-reported evalautions differ between men and women

### Plot

\TODO split histogram, split violin plot, raincloud plot, etc.

```{r}
#split histogram
# Create the base plot
splithistogramv1 <- ggplot(data_processed_after_exclusions, aes(x = AMP_score, fill = gender)) +
    geom_histogram(position = "dodge", binwidth = 0.15) + # Adjust binwidth as needed
    facet_grid(. ~ gender) + # Splitting the histogram by gender
    xlab("AMP score") +
    ylab("Mean self-reported evaluation") +
    theme_minimal()

# Add marginal histograms (if needed)
# ggMarginal(p1, groupColour = TRUE, groupFill = TRUE, type = "histogram")

# Print the plot
print(splithistogramv1)





# Create the split violin plot
splitviolinv1 <- ggplot(data_processed_after_exclusions, aes(x = gender, y = AMP_score, fill = gender)) +
    geom_violin(scale = "area", trim = FALSE) + # Violin plot
    geom_boxplot(width = 0.1, fill = "white") + # Add a boxplot inside the violin
    facet_wrap(~gender, scales = "free_x") + # Splitting by gender
    xlab("Gender") +
    ylab("AMP Score") +
    theme_minimal()

# Print the plot
print(splitviolinv1)


# Load necessary libraries
library(ggplot2)

install.packages("ggbeeswarm")
library(ggbeeswarm) # for geom_quasirandom

# Create the raincloud plot
raincloudplotv1 <- ggplot(data_processed_after_exclusions, aes(x = gender, y = AMP_score, fill = gender)) +
    # Add a half violin plot
    geom_violin(trim = FALSE, scale = "area", adjust = 1.5, alpha = 0.5) +
    # Add the boxplot
    geom_boxplot(width = 0.1, outlier.shape = NA, alpha = 0.5) +
    # Add points
    geom_quasirandom(aes(color = gender), size = 2, alpha = 0.5, show.legend = FALSE) +
    # Customizations
    scale_color_brewer(palette = "Dark2") +
    scale_fill_brewer(palette = "Dark2") +
    labs(x = "Gender", y = "AMP Score") +
    theme_minimal()

# Print the plot
print(raincloudplotv1)



```



### Test
\TODO run an appropriate test. Below the output, print an interpretation of the results generated by the ‘easystats’ package [report](https://easystats.github.io/report/). I.e., use `report::report()`.



```{r}



```

## Evaluations on the Affect Misattribution Procedure differ between men and women

### Plot

\TODO split histogram, split violin plot, raincloud plot, etc.

This time, vary the labeling and order of the legend, e.g., capitalise "Men" and "Women", and know how to change the order of the factors.

```{r}

splithistogramv2 <- ggplot(data_processed_after_exclusions, aes(x = AMP_score, fill = gender)) +
    geom_histogram(position = "dodge", binwidth = 0.15) + # Adjust binwidth as needed
    facet_grid(. ~ gender) + # Splitting the histogram by gender
    xlab("AMP score") +
    ylab("Mean self-reported evaluation") +
    scale_fill_manual(values = c("male" = "blue", "female" = "red", "nonbinary" = "green"),
                      labels = c("Men", "Women", "Nonbinary"),
                      breaks = c("male", "female", "nonbinary")) +
    theme_minimal()



# Print the plot
print(splithistogramv2)
```

### Test
\TODO run an appropriate test. Below the output, print an interpretation of the results generated by the ‘easystats’ package [report](https://easystats.github.io/report/). I.e., use `report::report()`.

```{r}
# The dataset includes four categories in the gender column: "male," "female," "nonbinary," and "other/missing/error." The counts for these categories are as follows:
# 
# Male: 55
# Female: 40
# Nonbinary: 3
# Other/Missing/Error: 2
# Given these distributions, here are the best statistical tests to consider for your hypothesis "Self-reported evaluations differ between men and women":
# 
# Two-sample T-test (Excluding Nonbinary and Other/Missing/Error): If your focus is strictly on comparing men and women, you can exclude the "nonbinary" and "other/missing/error" categories and perform a two-sample t-test. This is appropriate if you're specifically interested in the difference between "male" and "female" only.
# 
# ANOVA (Including All Categories): If you want to consider differences across all gender categories, an ANOVA test is suitable. This will tell you if there are overall differences in self-reported evaluations across the different gender categories. If the ANOVA shows significant results, you can then perform post-hoc tests to explore differences between specific pairs of groups (e.g., men vs. women, men vs. nonbinary).

# Kruskal-Wallis Test (Non-parametric Alternative): If your data does not meet the assumptions for an ANOVA (like normality), you can use the Kruskal-Wallis test as a non-parametric alternative. This test also works well when some groups have very small sample sizes, like the "nonbinary" group in your dataset.
# 
# Given the small number of nonbinary participants, the first option (a two-sample t-test excluding nonbinary and other/missing/error data) might be the most straightforward approach if your hypothesis is specifically about men versus women. However, if you want to consider all gender categories, an ANOVA followed by post-hoc tests would be a comprehensive approach.


library(dplyr)
library(report)

# Filter data for male and female
data_male_female <- data_processed %>%
  filter(gender %in% c("male", "female")) %>%
  na.omit()

# Run the t-test
t_test_result <- t.test(mean_evaluation ~ gender, data = data_male_female, var.equal = FALSE)

# Generate the report
t_test_report <- report::report(t_test_result)

# Print the report
print(t_test_report)


# Filter data to include nonbinary
data_all_genders <- data_processed %>%
  filter(gender %in% c("male", "female", "nonbinary")) %>%
  na.omit()

# Run ANOVA
anova_result <- aov(mean_evaluation ~ gender, data = data_all_genders)

# Generate the report
anova_report <- report::report(anova_result)

# Print the report
print(anova_report)



```

## Combining plots

Combine plots using patchwork: https://patchwork.data-imaginist.com/

\TODO Combine at least three of the above plots into one.

```{r}

install.packages("patchwork")
library(patchwork)


# Combine the plots
combined_plot <- splithistogramv1 / splitviolinv1 / raincloudplotv1

# Print the combined plot
print(combined_plot)

```

## Saving plots

Save plots to disk with `ggsave()`

\TODO Save the above combined plot to disk as both .png and .pdf. Ensure the png has at least 300dpi resolution.

```{r}

# Save as PNG with 300 DPI
ggsave("combined_plot.png", plot = combined_plot, dpi = 300)

# Save as PDF
ggsave("combined_plot.pdf", plot = combined_plot)

```

# Session info

```{r}

sessionInfo()

```



